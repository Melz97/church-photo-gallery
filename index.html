<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Throne of the Risen Christ International Ministry</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Material+Icons" />
    <style>
        /* ... your existing css ... */
        .article-card .admin-actions { /* NEW CSS for the buttons */
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 0.5rem;
        }
        .article-card .admin-btn {
            border: none;
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
        }
        .edit-btn { background-color: #D0BCFF; color: #21005D; }
        .delete-btn { background-color: #F2B8B5; color: #601410; }
    </style>
</head>
<body>
    <main>
        <section id="articles-section">
            <div class="section-header">
                <h3 class="md-title-large">Recent Articles</h3>
                <a href="create-article.html" class="publish-btn">Publish an Article</a>
            </div>
            <div id="articles-container"></div>
        </section>
        </main>
    <footer></footer>

    <script>
        // --- UPDATED JAVASCRIPT ---
        let adminPassword = null;

        async function deleteArticle(id) {
            if (!adminPassword) return;
            if (confirm("Are you sure you want to delete this article? This cannot be undone.")) {
                try {
                    const response = await fetch(`/api/articles/${id}`, {
                        method: 'DELETE',
                        headers: { 'x-admin-password': adminPassword }
                    });
                    if (!response.ok) throw new Error((await response.json()).message);
                    alert("Article deleted successfully.");
                    document.getElementById(`article-${id}`).remove(); // Remove the card from the page
                } catch (error) {
                    alert(`Deletion failed: ${error.message}`);
                }
            }
        }

        function editArticle(id) {
            window.location.href = `edit-article.html?id=${id}`;
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            if (params.get('admin') === 'true' && !sessionStorage.getItem('adminPassword')) {
                const pass = prompt("Enter admin password:");
                if (pass) {
                    sessionStorage.setItem('adminPassword', pass);
                }
            }
            adminPassword = sessionStorage.getItem('adminPassword');

            const articlesContainer = document.getElementById('articles-container');
            fetch('/api/articles')
              .then(response => response.json())
              .then(articles => {
                articlesContainer.innerHTML = '';
                articles.forEach(article => {
                    const articleCard = document.createElement('div');
                    articleCard.className = 'article-card';
                    articleCard.id = `article-${article.id}`; // Give each card a unique ID
                    const publishedDate = new Date(article.published_date || article.created_at).toLocaleDateString(/* ... */);
                    
                    let adminButtons = '';
                    if (adminPassword) {
                        adminButtons = `
                            <div class="admin-actions">
                                <button class="admin-btn edit-btn" onclick="editArticle(${article.id})">Edit</button>
                                <button class="admin-btn delete-btn" onclick="deleteArticle(${article.id})">Delete</button>
                            </div>
                        `;
                    }

                    articleCard.innerHTML = `
                        ${article.image_url ? `<img src="${article.image_url}" alt="${article.title}">` : ''}
                        <h4>${article.title}</h4>
                        <p class="meta">By ${article.author || 'Anonymous'} on ${publishedDate}</p>
                        <p>${article.content.substring(0, 200)}...</p>
                        <a href="article.html?id=${article.id}">Read More</a>
                        ${adminButtons}
                    `;
                    articlesContainer.appendChild(articleCard);
                });
              });
        });
    </script>
</body>
</html>